<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>GrupoGPS Mecanizada - Sistema de Avaliação de Segurança</title>
  <!-- Favicon -->
  <link rel="icon" href="data:,">

  <!-- Chart.js para gráficos -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

  <!-- Estilo CSS -->
  <style>
    :root {
      --primary-color: #0056b3;
      --secondary-color: #2e4b85;
      --accent-color: #28a745;
      --warning-color: #ffc107;
      --danger-color: #dc3545;
      --text-color: #333;
      --text-light: #777;
      --bg-color: #f8f9fa;
      --card-bg: #ffffff;
      --border-color: #ddd;
      --shadow-color: rgba(0,0,0,0.1);
    }

    * {
      box-sizing: border-box;
      font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
    }

    body {
      margin: 0;
      padding: 0;
      background-color: var(--bg-color);
      color: var(--text-color);
      line-height: 1.5;
    }

    .container {
      max-width: 100%;
      margin: 0 auto;
      padding: 10px;
    }

    .header {
      background-color: var(--primary-color);
      color: white;
      padding: 15px;
      border-radius: 8px 8px 0 0;
      margin-bottom: 15px;
      box-shadow: 0 2px 8px var(--shadow-color);
    }

    .header h1 {
      font-size: 20px;
      margin: 0;
    }

    .header p {
      font-size: 14px;
      margin: 5px 0 0;
      opacity: 0.9;
    }

    .company-branding {
      margin-bottom: 5px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .company-logo {
      font-size: 18px;
      font-weight: bold;
      color: white;
      text-decoration: none;
    }

    .notification-badge {
      background-color: var(--accent-color);
      color: white;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
    }

    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .date-filter {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .date-filter select {
      padding: 8px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      background-color: white;
    }

    .summary-cards {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 20px;
    }

    .card {
      background-color: var(--card-bg);
      border-radius: 8px;
      box-shadow: 0 2px 8px var(--shadow-color);
      padding: 20px;
      flex: 1 1 calc(25% - 15px);
      min-width: 200px;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 15px var(--shadow-color);
    }

    .card-title {
      font-size: 14px;
      color: var(--text-light);
      margin-bottom: 10px;
      display: flex;
      align-items: center;
    }

    .card-title i {
      margin-right: 8px;
      font-size: 16px;
    }

    .card-value {
      font-size: 24px;
      font-weight: bold;
      color: var(--primary-color);
    }

    .card-footer {
      margin-top: 10px;
      font-size: 12px;
      color: var(--text-light);
      display: flex;
      align-items: center;
    }

    .card-trend {
      margin-left: 8px;
      padding: 3px 6px;
      border-radius: 12px;
      font-weight: bold;
    }

    .trend-up {
      background-color: rgba(40, 167, 69, 0.1);
      color: var(--accent-color);
    }

    .trend-down {
      background-color: rgba(220, 53, 69, 0.1);
      color: var(--danger-color);
    }

    .section {
      background-color: var(--card-bg);
      border-radius: 8px;
      box-shadow: 0 2px 8px var(--shadow-color);
      padding: 20px;
      margin-bottom: 20px;
    }

    .section-title {
      font-size: 18px;
      color: var(--text-color);
      margin: 0 0 15px 0;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .section-actions {
      display: flex;
      gap: 10px;
    }

    .btn-icon {
      background: none;
      border: none;
      color: var(--text-light);
      cursor: pointer;
      padding: 5px;
      border-radius: 4px;
      transition: background-color 0.2s;
    }

    .btn-icon:hover {
      background-color: rgba(0,0,0,0.05);
      color: var(--primary-color);
    }

    .chart-container {
      position: relative;
      height: 300px;
      margin-bottom: 20px;
    }

    .grid-container {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      margin-bottom: 20px;
    }

    .table-responsive {
      overflow-x: auto;
      border-radius: 8px;
      border: 1px solid var(--border-color);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
      background-color: white;
    }

    th {
      background-color: rgba(0,0,0,0.03);
      text-align: left;
      padding: 12px 15px;
      border-bottom: 2px solid var(--border-color);
      color: var(--text-color);
      font-weight: 600;
    }

    td {
      padding: 12px 15px;
      border-bottom: 1px solid var(--border-color);
      vertical-align: middle;
    }

    tr:hover {
      background-color: rgba(0,0,0,0.01);
    }

    tr:last-child td {
      border-bottom: none;
    }

    .ranking-number {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background-color: var(--bg-color);
      color: var(--text-color);
      font-weight: bold;
      margin-right: 10px;
    }

    .ranking-row-1 .ranking-number {
      background-color: gold;
      color: #333;
    }

    .ranking-row-2 .ranking-number {
      background-color: silver;
      color: #333;
    }

    .ranking-row-3 .ranking-number {
      background-color: #cd7f32; /* bronze */
      color: white;
    }

    .score-badge {
      display: inline-block;
      padding: 5px 8px;
      border-radius: 4px;
      font-weight: bold;
      font-size: 13px;
    }

    .score-high {
      background-color: rgba(40, 167, 69, 0.1);
      color: var(--accent-color);
    }

    .score-medium {
      background-color: rgba(255, 193, 7, 0.1);
      color: #d49c00;
    }

    .score-low {
      background-color: rgba(220, 53, 69, 0.1);
      color: var(--danger-color);
    }

    .tabs {
      display: flex;
      border-bottom: 1px solid var(--border-color);
      margin-bottom: 20px;
      overflow-x: auto;
      scrollbar-width: thin;
    }

    .tab {
      padding: 12px 20px;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 500;
      white-space: nowrap;
      border-bottom: 2px solid transparent;
    }

    .tab.active {
      color: var(--primary-color);
      border-bottom: 2px solid var(--primary-color);
    }

    .tab:hover:not(.active) {
      border-bottom: 2px solid rgba(0,0,0,0.1);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .search-container {
      margin-bottom: 20px;
    }

    .search-input {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 15px;
      transition: all 0.2s;
      background-color: white;
    }

    .search-input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(0, 86, 179, 0.1);
    }

    .filter-container {
      display: flex;
      margin-bottom: 20px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      padding-bottom: 5px;
      gap: 10px;
    }

    .filter-item {
      background-color: white;
      border: 1px solid var(--border-color);
      border-radius: 20px;
      padding: 8px 15px;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
      flex-shrink: 0;
    }

    .filter-item.active {
      background-color: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }

    .filter-item:hover:not(.active) {
      background-color: rgba(0,0,0,0.03);
    }

    .badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }

    .badge-success {
      background-color: var(--accent-color);
      color: white;
    }

    .badge-warning {
      background-color: var(--warning-color);
      color: #212529;
    }

    .badge-danger {
      background-color: var(--danger-color);
      color: white;
    }

    .badge-info {
      background-color: #17a2b8;
      color: white;
    }

    .progress-container {
      width: 100%;
      background-color: var(--bg-color);
      border-radius: 4px;
      height: 8px;
      overflow: hidden;
      margin-top: 5px;
    }

    .progress-bar {
      height: 100%;
      background-color: var(--accent-color);
      border-radius: 4px;
      transition: width 0.5s;
    }

    .btn {
      display: inline-block;
      background-color: var(--primary-color);
      color: white;
      padding: 10px 15px;
      border-radius: 4px;
      text-decoration: none;
      border: none;
      cursor: pointer;
      font-size: 15px;
      font-weight: 500;
      text-align: center;
      transition: all 0.2s;
    }

    .btn:hover {
      background-color: var(--secondary-color);
    }

    .btn-success {
      background-color: var(--accent-color);
    }

    .btn-success:hover {
      background-color: #218838;
    }

    .btn-danger {
      background-color: var(--danger-color);
    }

    .btn-danger:hover {
      background-color: #bd2130;
    }

    .btn-sm {
      padding: 5px 10px;
      font-size: 13px;
    }

    .btn-lg {
      padding: 12px 20px;
      font-size: 16px;
    }

    .btn-block {
      display: block;
      width: 100%;
    }

    .btn-outline {
      background-color: transparent;
      border: 1px solid var(--primary-color);
      color: var(--primary-color);
    }

    .btn-outline:hover {
      background-color: var(--primary-color);
      color: white;
    }

    .btn-outline-success {
      border-color: var(--accent-color);
      color: var(--accent-color);
    }

    .btn-outline-success:hover {
      background-color: var(--accent-color);
      color: white;
    }

    .btn-new {
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background-color: var(--accent-color);
      color: white;
      text-align: center;
      line-height: 60px;
      font-size: 24px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      z-index: 100;
      transition: all 0.3s ease;
    }

    .btn-new:hover {
      transform: scale(1.1);
      background-color: #218838;
    }

    .btn-action-group {
      display: flex;
      gap: 10px;
    }

    /* Estilos para o formulário de avaliação */
    .form-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      z-index: 1000;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .form-container {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 90%;
      max-width: 700px;
      max-height: 90vh;
      overflow-y: auto;
      background-color: white;
      border-radius: 8px;
      padding: 25px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }

    .form-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 15px;
    }

    .form-title {
      font-size: 20px;
      font-weight: 600;
      margin: 0;
    }

    .form-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--text-light);
      transition: color 0.2s;
    }

    .form-close:hover {
      color: var(--danger-color);
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      font-size: 15px;
    }

    .form-control {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      font-size: 15px;
      transition: all 0.2s;
    }

    .form-control:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(0, 86, 179, 0.1);
    }

    .form-row {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
    }

    .form-col {
      flex: 1;
    }

    .form-check {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
    }

    .form-check input[type="radio"] {
      margin-right: 8px;
    }

    .form-check label {
      margin: 0;
      font-weight: normal;
    }

    .form-item {
      background-color: #f9f9f9;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      border: 1px solid var(--border-color);
    }

    .form-item-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 10px;
    }

    .form-item-title {
      font-weight: 600;
      margin-bottom: 10px;
      font-size: 15px;
      flex: 1;
    }

    .form-item-number {
      background-color: var(--primary-color);
      color: white;
      width: 25px;
      height: 25px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      margin-right: 10px;
      flex-shrink: 0;
    }

    .form-steps {
      display: flex;
      justify-content: space-between;
      margin-bottom: 30px;
      position: relative;
    }

    .form-steps::before {
      content: '';
      position: absolute;
      top: 14px;
      left: 0;
      right: 0;
      height: 2px;
      background-color: var(--border-color);
      z-index: 1;
    }

    .form-step {
      position: relative;
      z-index: 2;
      text-align: center;
      flex: 1;
    }

    .step-number {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background-color: white;
      border: 2px solid var(--border-color);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 8px;
      font-weight: bold;
      color: var(--text-light);
      position: relative;
      z-index: 2;
    }

    .form-step.active .step-number {
      background-color: var(--primary-color);
      border-color: var(--primary-color);
      color: white;
    }

    .form-step.completed .step-number {
      background-color: var(--accent-color);
      border-color: var(--accent-color);
      color: white;
    }

    .step-label {
      font-size: 13px;
      color: var(--text-light);
    }

    .form-step.active .step-label {
      color: var(--primary-color);
      font-weight: 500;
    }

    .form-step.completed .step-label {
      color: var(--accent-color);
      font-weight: 500;
    }

    .form-navigation {
      display: flex;
      justify-content: space-between;
      margin-top: 30px;
      border-top: 1px solid var(--border-color);
      padding-top: 20px;
    }

    .form-required {
      color: var(--danger-color);
      margin-left: 2px;
    }

    .notification-popup {
      position: fixed;
      top: 20px;
      right: 20px;
      min-width: 280px;
      max-width: 350px;
      padding: 15px 20px;
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      z-index: 1050;
      animation: slideIn 0.3s ease-out forwards;
      font-weight: 500;
      display: flex;
      align-items: flex-start;
    }

    .notification-icon {
      margin-right: 12px;
      font-size: 20px;
    }

    .notification-content {
      flex: 1;
    }

    .notification-title {
      font-weight: 600;
      margin-bottom: 5px;
      font-size: 16px;
    }

    .notification-popup.success {
      background-color: #d4edda;
      border-left: 4px solid var(--accent-color);
      color: #155724;
    }

    .notification-popup.error {
      background-color: #f8d7da;
      border-left: 4px solid var(--danger-color);
      color: #721c24;
    }

    .notification-popup.info {
      background-color: #d1ecf1;
      border-left: 4px solid #17a2b8;
      color: #0c5460;
    }

    .notification-popup .close-btn {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 16px;
      cursor: pointer;
      color: inherit;
      opacity: 0.7;
    }

    .notification-popup .close-btn:hover {
      opacity: 1;
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes fadeOut {
      from {
        opacity: 1;
      }
      to {
        opacity: 0;
      }
    }

    .dropdown {
      position: relative;
      display: inline-block;
    }

    .dropdown-content {
      display: none;
      position: absolute;
      right: 0;
      background-color: white;
      min-width: 180px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      border-radius: 8px;
      z-index: 10;
    }

    .dropdown-menu-item {
      padding: 10px 15px;
      display: block;
      font-size: 14px;
      color: var(--text-color);
      text-decoration: none;
      cursor: pointer;
      transition: all 0.2s;
    }

    .dropdown-menu-item:hover {
      background-color: rgba(0,0,0,0.03);
      color: var(--primary-color);
    }

    .dropdown-divider {
      height: 1px;
      background-color: var(--border-color);
      margin: 5px 0;
    }

    .show {
      display: block;
    }

    .footer {
      text-align: center;
      padding: 20px 0;
      color: var(--text-light);
      font-size: 13px;
      margin-top: 30px;
      border-top: 1px solid var(--border-color);
    }

    .developer-credit {
      font-size: 12px;
      color: var(--text-light);
      margin-top: 5px;
    }

    /* Estilos específicos para funcionários em destaque */
    .employee-highlight {
      display: flex;
      align-items: center;
      padding: 15px;
      border-radius: 8px;
      background-color: rgba(0,0,0,0.02);
      margin-bottom: 15px;
      border: 1px solid var(--border-color);
    }

    .employee-avatar {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      background-color: #e9ecef;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      font-weight: bold;
      color: var(--primary-color);
      margin-right: 15px;
      flex-shrink: 0;
    }

    .employee-info {
      flex: 1;
    }

    .employee-name {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 5px;
    }

    .employee-position {
      font-size: 14px;
      color: var(--text-light);
      margin-bottom: 8px;
    }

    .employee-stats {
      display: flex;
      gap: 20px;
    }

    .stat-item {
      flex: 1;
    }

    .stat-label {
      font-size: 12px;
      color: var(--text-light);
      margin-bottom: 5px;
    }

    .stat-value {
      font-size: 18px;
      font-weight: 600;
      color: var(--primary-color);
    }

    /* Responsividade */
    @media (max-width: 768px) {
      .grid-container {
        grid-template-columns: 1fr;
      }

      .summary-cards {
        flex-direction: column;
      }

      .card {
        flex: 1 1 100%;
        min-width: 100%;
      }

      .form-row {
        flex-direction: column;
        gap: 10px;
      }

      .employee-highlight {
        flex-direction: column;
        text-align: center;
      }

      .employee-avatar {
        margin: 0 auto 15px;
      }

      .employee-stats {
        flex-direction: column;
        gap: 10px;
      }

      .form-steps {
        overflow-x: auto;
        padding-bottom: 10px;
      }

      .step-label {
        font-size: 11px;
      }

      .btn-new {
        width: 50px;
        height: 50px;
        line-height: 50px;
        font-size: 20px;
        bottom: 20px;
        right: 20px;
      }

      .section {
        padding: 15px;
      }

      .form-container {
        width: 95%;
        padding: 15px;
      }
    }

    @media (min-width: 769px) and (max-width: 1024px) {
      .grid-container {
        grid-template-columns: 1fr 1fr;
      }

      .card {
        flex: 1 1 calc(50% - 15px);
      }
    }

    @media (min-width: 1025px) {
      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      .chart-container {
        height: 350px;
      }
    }

    .text-center { /* Helper class, if needed by JS updates */
        text-align: center;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <div class="company-branding">
        <a href="#" class="company-logo">GrupoGPS - Mecanizada</a>
        <span class="notification-badge">Avaliação</span>
      </div>
      <h1>Sistema de Avaliação Individual de Indicadores de Segurança</h1>
      <p>Desempenho e monitoramento da equipe</p>
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="dashboard">Dashboard</div>
      <div class="tab" data-tab="ranking">Ranking</div>
      <div class="tab" data-tab="employees">Funcionários</div>
      <div class="tab" data-tab="reports">Relatórios</div>
    </div>

    <!-- Dashboard Tab -->
    <div class="tab-content active" id="tab-dashboard">
      <div class="dashboard-header">
        <h2>Visão Geral</h2>
        <div class="date-filter">
          <label for="period-filter">Período:</label>
          <select id="period-filter">
            <option value="all">Todos</option>
            <option value="current-month" selected>Mês Atual</option>
            <option value="last-month">Mês Anterior</option>
            <option value="last-3-months">Últimos 3 Meses</option>
          </select>
        </div>
      </div>

      <!-- Resumo em cards -->
      <div class="summary-cards">
        <div class="card">
          <div class="card-title">
            <i class="icon">👥</i>
            Total de Funcionários
          </div>
          <div class="card-value" id="total-employees">0</div>
          <div class="card-footer">
            Atualizado hoje
          </div>
        </div>

        <div class="card">
          <div class="card-title">
            <i class="icon">📋</i>
            Avaliações Realizadas
          </div>
          <div class="card-value" id="total-evaluations">0</div>
          <div class="card-footer">
            No período selecionado
          </div>
        </div>

        <div class="card">
          <div class="card-title">
            <i class="icon">📊</i>
            Pontuação Média
          </div>
          <div class="card-value" id="average-score">0%</div>
          <div class="card-footer">
            <span>Período atual</span>
            <span class="card-trend trend-up" id="score-trend">+2.5%</span>
          </div>
        </div>

        <div class="card">
          <div class="card-title">
            <i class="icon">🏆</i>
            Destaque do Mês
          </div>
          <div class="card-value" id="top-employee">-</div>
          <div class="card-footer">
            <span id="top-employee-score">Pontuação: 0%</span>
          </div>
        </div>
      </div>

      <!-- Funcionário em Destaque -->
      <div class="section">
        <h3 class="section-title">Funcionário em Destaque</h3>
        <div class="employee-highlight" id="employee-highlight">
          <div class="employee-avatar" id="employee-avatar">TP</div>
          <div class="employee-info">
            <div class="employee-name" id="highlight-name">Carregando...</div>
            <div class="employee-position" id="highlight-position">Carregando...</div>
            <div class="employee-stats">
              <div class="stat-item">
                <div class="stat-label">Pontuação Média</div>
                <div class="stat-value" id="highlight-score">0%</div>
              </div>
              <div class="stat-item">
                <div class="stat-label">Posição no Ranking</div>
                <div class="stat-value" id="highlight-rank">-</div>
              </div>
              <div class="stat-item">
                <div class="stat-label">Avaliações</div>
                <div class="stat-value" id="highlight-evaluations">0</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Gráficos -->
      <div class="grid-container">
        <div class="section">
          <h3 class="section-title">
            Evolução da Pontuação Média
            <div class="section-actions">
              <button class="btn-icon" id="refresh-trend-chart" title="Atualizar">↻</button>
            </div>
          </h3>
          <div class="chart-container">
            <canvas id="trend-chart"></canvas>
          </div>
        </div>

        <div class="section">
          <h3 class="section-title">
            Distribuição por Pontuação
            <div class="section-actions">
              <button class="btn-icon" id="refresh-distribution-chart" title="Atualizar">↻</button>
            </div>
          </h3>
          <div class="chart-container">
            <canvas id="distribution-chart"></canvas>
          </div>
        </div>
      </div>

      <!-- Últimas Avaliações -->
      <div class="section">
        <h3 class="section-title">Últimas Avaliações</h3>
        <div class="table-responsive">
          <table id="recent-evaluations-table">
            <thead>
              <tr>
                <th>Funcionário</th>
                <th>Data</th>
                <th>Período Avaliado</th>
                <th>Pontuação</th>
                <th>Avaliador</th>
              </tr>
            </thead>
            <tbody id="recent-evaluations-tbody">
              <tr>
                <td colspan="5" class="text-center">Carregando dados...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Ranking Tab -->
    <div class="tab-content" id="tab-ranking">
      <div class="section">
        <div class="search-container">
          <input type="text" class="search-input" id="ranking-search" placeholder="Buscar funcionário...">
        </div>

        <div class="filter-container">
          <div class="filter-item active" data-filter="all">Todos</div>
          <div class="filter-item" data-filter="high">Alta Pontuação (>80%)</div>
          <div class="filter-item" data-filter="medium">Média Pontuação (60-80%)</div>
          <div class="filter-item" data-filter="low">Baixa Pontuação (<60%)</div>
        </div>

        <h3 class="section-title">
          Ranking de Desempenho
          <div class="section-actions">
            <button class="btn-icon" id="refresh-ranking" title="Atualizar Ranking">↻</button>
          </div>
        </h3>

        <div class="table-responsive">
          <table id="ranking-table">
            <thead>
              <tr>
                <th>Posição</th>
                <th>Funcionário</th>
                <th>Pontuação Média</th>
                <th>Avaliações</th>
                <th>Tendência</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody id="ranking-tbody">
              <tr>
                <td colspan="6" class="text-center">Carregando dados...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Progresso Mensal -->
      <div class="section">
        <h3 class="section-title">Progresso Mensal dos Top 5</h3>
        <div class="chart-container">
          <canvas id="top-employees-chart"></canvas>
        </div>
      </div>
    </div>

    <!-- Funcionários Tab -->
    <div class="tab-content" id="tab-employees">
      <div class="section">
        <div class="search-container">
          <input type="text" class="search-input" id="employee-search" placeholder="Buscar por nome, cargo ou setor...">
        </div>

        <h3 class="section-title">
          Lista de Funcionários
          <div class="section-actions">
            <button class="btn btn-outline" id="add-employee">+ Novo Funcionário</button> <!-- Corrigido para usar btn e btn-outline -->
          </div>
        </h3>

        <div class="table-responsive">
          <table id="employees-table">
            <thead>
              <tr>
                <th>Nome</th>
                <th>Cargo</th>
                <th>Setor</th>
                <th>Data Admissão</th>
                <th>Status</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody id="employees-tbody">
              <tr>
                <td colspan="6" class="text-center">Carregando dados...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Estatísticas por Setor -->
      <div class="section">
        <h3 class="section-title">Estatísticas por Setor</h3>
        <div class="chart-container">
          <canvas id="sector-stats-chart"></canvas>
        </div>
      </div>
    </div>

    <!-- Relatórios Tab -->
    <div class="tab-content" id="tab-reports">
      <div class="section">
        <h3 class="section-title">Relatórios Mensais</h3>
        <div class="table-responsive">
          <table id="monthly-reports-table">
            <thead>
              <tr>
                <th>Mês/Ano</th>
                <th>Total Avaliações</th>
                <th>Média Geral</th>
                <th>Melhor Funcionário</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody id="monthly-reports-tbody">
              <tr>
                <td colspan="5" class="text-center">Carregando dados...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="section">
        <h3 class="section-title">Análise Comparativa</h3>
        <div class="chart-container">
          <canvas id="comparative-chart"></canvas>
        </div>
      </div>

      <div class="section">
        <h3 class="section-title">Exportar Dados</h3>
        <div class="btn-action-group">
          <button class="btn" id="export-excel">Exportar para Excel</button>
          <button class="btn" id="export-pdf">Exportar para PDF</button>
          <button class="btn" id="print-report">Imprimir Relatório</button>
        </div>
      </div>
    </div>

    <!-- Formulário de Nova Avaliação -->
    <div class="form-overlay" id="evaluation-form-overlay">
      <div class="form-container">
        <div class="form-header">
          <h2 class="form-title">Nova Avaliação de Segurança</h2>
          <button class="form-close" id="close-evaluation-form">&times;</button>
        </div>

        <div class="form-steps">
          <div class="form-step active" data-step="1">
            <div class="step-number">1</div>
            <div class="step-label">Informações</div>
          </div>
          <div class="form-step" data-step="2">
            <div class="step-number">2</div>
            <div class="step-label">Critérios</div>
          </div>
          <div class="form-step" data-step="3">
            <div class="step-number">3</div>
            <div class="step-label">Revisão</div>
          </div>
        </div>

        <form id="evaluation-form">
          <!-- Etapa 1: Informações Básicas -->
          <div class="form-step-content" id="step-1-content">
            <div class="form-row">
              <div class="form-col">
                <div class="form-group">
                  <label for="employee-name">Nome do Funcionário <span class="form-required">*</span></label>
                  <input type="text" class="form-control" id="employee-name" name="employee-name" required>
                </div>
              </div>
              <div class="form-col">
                <div class="form-group">
                  <label for="evaluator-name">Nome do Avaliador <span class="form-required">*</span></label>
                  <input type="text" class="form-control" id="evaluator-name" name="evaluator-name" required>
                </div>
              </div>
            </div>

            <div class="form-row">
              <div class="form-col">
                <div class="form-group">
                  <label for="start-date">Período de Avaliação - Início <span class="form-required">*</span></label>
                  <input type="date" class="form-control" id="start-date" name="start-date" required>
                </div>
              </div>
              <div class="form-col">
                <div class="form-group">
                  <label for="end-date">Período de Avaliação - Fim <span class="form-required">*</span></label>
                  <input type="date" class="form-control" id="end-date" name="end-date" required>
                </div>
              </div>
            </div>

            <div class="form-group">
              <label for="sector">Setor <span class="form-required">*</span></label>
              <select class="form-control" id="sector" name="sector" required>
                <option value="">Selecione o setor</option>
                <option value="Mecanizada" selected>Mecanizada</option>
                <option value="Administrativo">Administrativo</option>
                <option value="Manutenção">Manutenção</option>
              </select>
            </div>

            <div class="form-navigation">
              <button type="button" class="btn" id="cancel-evaluation">Cancelar</button>
              <button type="button" class="btn btn-success" id="next-to-step-2">Próximo</button>
            </div>
          </div>

          <!-- Etapa 2: Critérios de Avaliação -->
          <div class="form-step-content" id="step-2-content" style="display: none;">
            <div id="evaluation-criteria">
              <!-- Os critérios serão inseridos dinamicamente via JavaScript -->
            </div>

            <div class="form-navigation">
              <button type="button" class="btn" id="back-to-step-1">Voltar</button>
              <button type="button" class="btn btn-success" id="next-to-step-3">Próximo</button>
            </div>
          </div>

          <!-- Etapa 3: Revisão e Envio -->
          <div class="form-step-content" id="step-3-content" style="display: none;">
            <div class="form-group">
              <label for="observations">Observações</label>
              <textarea class="form-control" id="observations" name="observations" rows="4" placeholder="Observações adicionais sobre a avaliação..."></textarea>
            </div>

            <div class="section">
              <h3 class="section-title">Resumo da Avaliação</h3>
              <div id="evaluation-summary">
                <!-- O resumo será inserido dinamicamente via JavaScript -->
              </div>
            </div>

            <div class="form-navigation">
              <button type="button" class="btn" id="back-to-step-2">Voltar</button>
              <button type="submit" class="btn btn-success" id="submit-evaluation">Finalizar Avaliação</button>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- Formulário de Novo Funcionário -->
    <div class="form-overlay" id="employee-form-overlay">
      <div class="form-container">
        <div class="form-header">
          <h2 class="form-title">Cadastrar Novo Funcionário</h2>
          <button class="form-close" id="close-employee-form">&times;</button>
        </div>

        <form id="employee-form">
          <div class="form-group">
            <label for="new-employee-name">Nome Completo <span class="form-required">*</span></label>
            <input type="text" class="form-control" id="new-employee-name" name="new-employee-name" required>
          </div>

          <div class="form-row">
            <div class="form-col">
              <div class="form-group">
                <label for="new-employee-position">Cargo <span class="form-required">*</span></label>
                <input type="text" class="form-control" id="new-employee-position" name="new-employee-position" required>
              </div>
            </div>
            <div class="form-col">
              <div class="form-group">
                <label for="new-employee-sector">Setor <span class="form-required">*</span></label>
                <select class="form-control" id="new-employee-sector" name="new-employee-sector" required>
                  <option value="">Selecione o setor</option>
                  <option value="Mecanizada" selected>Mecanizada</option>
                  <option value="Administrativo">Administrativo</option>
                  <option value="Manutenção">Manutenção</option>
                </select>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label for="admission-date">Data de Admissão</label>
            <input type="date" class="form-control" id="admission-date" name="admission-date">
          </div>

          <div class="form-navigation">
            <button type="button" class="btn" id="cancel-employee">Cancelar</button>
            <button type="submit" class="btn btn-success">Salvar</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Botão de Nova Avaliação -->
    <div class="btn-new" id="new-evaluation">+</div>

    <div class="footer">
      <p>Sistema de Avaliação de Segurança © 2025 | Última atualização: <span id="last-update">Carregando...</span></p>
      <p class="developer-credit">Desenvolvido por Warlison Abreu</p>
    </div>
  </div>

  <script>
    // Configuração da URL da API (URL do seu Google Script Web App publicado)
    const API_URL = 'https://script.google.com/macros/s/AKfycbyggi51qCUjVCVR2Dsc92jVm_EW859onxwUgTzIKLlql3QrWvaxv6QvkGczb3HFUpbF1w/exec'; // SUBSTITUA PELO SEU ID

    // Variáveis globais
    let dashboardData = null;
    let criteriosAvaliacao = [];
    let currentTab = 'dashboard';
    let currentFilter = 'all';
    let searchTerm = '';
    let charts = {};

    // Document ready
    document.addEventListener('DOMContentLoaded', function() {
      // Inicializar o sistema
      setupEventListeners();
      loadCriteriosAvaliacao();
      loadDashboardData();

      // Define a data de hoje como padrão nos campos de data
      const today = new Date();
      const oneMonthAgo = new Date();
      oneMonthAgo.setMonth(today.getMonth() - 1);

      document.getElementById('start-date').valueAsDate = oneMonthAgo;
      document.getElementById('end-date').valueAsDate = today;
      document.getElementById('admission-date').valueAsDate = today;

      document.getElementById('last-update').textContent = formatDate(today, true);
    });

    // Função para chamar a API via JSONP
    function callAPI(action, data = {}) {
      return new Promise((resolve, reject) => {
        try {
          // Nome único para a função de callback
          const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());

          // Criar uma função global que será chamada pelo script
          window[callbackName] = function(response) {
            // Remover o script após execução
            if (script && script.parentNode) {
              script.parentNode.removeChild(script);
            }

            // Limpar o callback global
            delete window[callbackName];

            // Resolver a promessa com os dados
            resolve(response);
          };

          // Converter dados para string
          const dataStr = JSON.stringify(data);

          // Construir URL com parâmetros
          const url = `${API_URL}?action=${action}&data=${encodeURIComponent(dataStr)}&callback=${callbackName}&nocache=${Date.now()}`;

          // Criar elemento de script
          const script = document.createElement('script');
          script.src = url;

          // Lidar com erros
          script.onerror = () => {
            // Remover o script
            if (script.parentNode) {
              script.parentNode.removeChild(script);
            }

            // Limpar o callback
            delete window[callbackName];

            // Rejeitar a promessa
            reject(new Error('Falha na requisição JSONP'));
          };

          // Definir um timeout para evitar solicitações penduradas
          const timeoutId = setTimeout(() => {
            if (script && script.parentNode) { // Adicionado verificação se script existe
              script.parentNode.removeChild(script);
            }
            delete window[callbackName];
            reject(new Error('Timeout na requisição JSONP'));
          }, 30000); // 30 segundos

          // Substituir o handler de sucesso para limpar o timeout
          const originalCallback = window[callbackName];
          window[callbackName] = function(response) {
            clearTimeout(timeoutId);
            originalCallback(response);
          };

          // Adicionar o script ao documento para iniciar a solicitação
          document.body.appendChild(script);

        } catch (error) {
          reject(error);
        }
      });
    }

    // Configurar event listeners
    function setupEventListeners() {
      // Navegação por tabs
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', function() {
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

          this.classList.add('active');
          currentTab = this.getAttribute('data-tab');
          document.getElementById(`tab-${currentTab}`).classList.add('active');

          // Atualizar conteúdo da tab selecionada
          if (currentTab === 'ranking') {
            updateRankingTable();
            renderTopEmployeesChart();
          } else if (currentTab === 'employees') {
            updateEmployeesTable();
            renderSectorStatsChart();
          } else if (currentTab === 'reports') {
            updateReportsTable();
            renderComparativeChart();
          }
        });
      });

      // Filtros de ranking
      document.querySelectorAll('.filter-item').forEach(filter => {
        filter.addEventListener('click', function() {
          document.querySelectorAll('.filter-item').forEach(f => f.classList.remove('active'));
          this.classList.add('active');

          currentFilter = this.getAttribute('data-filter');
          if (currentTab === 'ranking') {
            updateRankingTable();
          }
        });
      });

      // Busca
      document.getElementById('ranking-search').addEventListener('input', function() {
        searchTerm = this.value;
        updateRankingTable();
      });

      document.getElementById('employee-search').addEventListener('input', function() {
        searchTerm = this.value;
        updateEmployeesTable();
      });

      // Filtro de período
      document.getElementById('period-filter').addEventListener('change', function() {
        loadDashboardData();
      });

      // Botões de refresh
      document.getElementById('refresh-trend-chart').addEventListener('click', function() {
        renderTrendChart();
      });

      document.getElementById('refresh-distribution-chart').addEventListener('click', function() {
        renderDistributionChart();
      });

      document.getElementById('refresh-ranking').addEventListener('click', function() {
        callAPI('atualizarRelatorios')
          .then(() => {
            loadDashboardData();
            showNotification('Ranking atualizado com sucesso!', 'success');
          })
          .catch(error => {
            showNotification('Erro ao atualizar ranking: ' + error.message, 'error');
          });
      });

      // Botões de exportação
      document.getElementById('export-excel').addEventListener('click', function() {
        showNotification('Exportação para Excel iniciada...', 'info');
        // Implementar exportação
      });

      document.getElementById('export-pdf').addEventListener('click', function() {
        showNotification('Exportação para PDF iniciada...', 'info');
        // Implementar exportação
      });

      document.getElementById('print-report').addEventListener('click', function() {
        window.print();
      });

      // Botão de nova avaliação
      document.getElementById('new-evaluation').addEventListener('click', function() {
        openEvaluationForm();
      });

      // Botão de adicionar funcionário
      document.getElementById('add-employee').addEventListener('click', function() {
        openEmployeeForm();
      });

      // Fechar formulários
      document.getElementById('close-evaluation-form').addEventListener('click', function() {
        closeEvaluationForm();
      });

      document.getElementById('close-employee-form').addEventListener('click', function() {
        closeEmployeeForm();
      });

      // Navegação no formulário de avaliação
      document.getElementById('next-to-step-2').addEventListener('click', function() {
        const employeeName = document.getElementById('employee-name').value;
        const evaluatorName = document.getElementById('evaluator-name').value;
        const startDate = document.getElementById('start-date').value;
        const endDate = document.getElementById('end-date').value;
        const sector = document.getElementById('sector').value;

        if (!employeeName || !evaluatorName || !startDate || !endDate || !sector) {
          showNotification('Por favor, preencha todos os campos obrigatórios.', 'error');
          return;
        }

        // Verificar se o funcionário existe
        callAPI('verificarFuncionario', { nome: employeeName })
          .then(result => {
            if (result.exists) {
              // Avançar para a próxima etapa
              goToFormStep(2);
            } else {
              // Perguntar se deseja cadastrar o funcionário
              if (confirm(`Funcionário "${employeeName}" não encontrado. Deseja cadastrá-lo agora?`)) {
                // Pré-preencher o formulário de novo funcionário
                document.getElementById('new-employee-name').value = employeeName;
                closeEvaluationForm();
                openEmployeeForm();
              }
            }
          })
          .catch(error => {
            showNotification('Erro ao verificar funcionário: ' + error.message, 'error');
          });
      });

      document.getElementById('back-to-step-1').addEventListener('click', function() {
        goToFormStep(1);
      });

      document.getElementById('next-to-step-3').addEventListener('click', function() {
        // Verificar se todos os critérios foram respondidos
        const criterioItems = document.querySelectorAll('.form-item');
        let allAnswered = true;

        criterioItems.forEach(item => {
          const criterioId = item.getAttribute('data-id');
          const radioChecked = document.querySelector(`input[name="${criterioId}"]:checked`);

          if (!radioChecked) {
            allAnswered = false;
            item.style.border = '1px solid red'; // Visual feedback
          } else {
            item.style.border = '1px solid var(--border-color)'; // Reset feedback
          }
        });

        if (!allAnswered) {
          showNotification('Por favor, responda todos os critérios de avaliação.', 'error');
          return;
        }

        // Preencher o resumo da avaliação
        updateEvaluationSummary();

        // Avançar para a próxima etapa
        goToFormStep(3);
      });

      document.getElementById('back-to-step-2').addEventListener('click', function() {
        goToFormStep(2);
      });

      // Cancelar formulários
      document.getElementById('cancel-evaluation').addEventListener('click', function() {
        closeEvaluationForm();
      });

      document.getElementById('cancel-employee').addEventListener('click', function() {
        closeEmployeeForm();
      });

      // Envio dos formulários
      document.getElementById('evaluation-form').addEventListener('submit', function(e) {
        e.preventDefault();
        submitEvaluation();
      });

      document.getElementById('employee-form').addEventListener('submit', function(e) {
        e.preventDefault();
        submitEmployee();
      });

      // Fechar formulários clicando fora deles
      document.getElementById('evaluation-form-overlay').addEventListener('click', function(e) {
        if (e.target === this) {
          closeEvaluationForm();
        }
      });

      document.getElementById('employee-form-overlay').addEventListener('click', function(e) {
        if (e.target === this) {
          closeEmployeeForm();
        }
      });
    }

    // Carregar critérios de avaliação
    function loadCriteriosAvaliacao() {
      callAPI('getCriteriosAvaliacao')
        .then(data => {
          if (data && Array.isArray(data)) { // Verifica se é um array
             criteriosAvaliacao = data;
             // Se o formulário já estiver aberto, regera os critérios
             if (document.getElementById('evaluation-form-overlay').style.display === 'block') {
                generateEvaluationCriteria();
             }
          } else {
              console.error('Formato inesperado para critérios de avaliação:', data);
              showNotification('Erro ao carregar critérios: formato inválido.', 'error');
          }
        })
        .catch(error => {
          showNotification('Erro ao carregar critérios de avaliação: ' + error.message, 'error');
        });
    }

    // Carregar dados do dashboard
    function loadDashboardData() {
      showLoading(true);

      callAPI('getDashboardData')
        .then(data => {
          dashboardData = data;
          updateDashboard();
          showLoading(false);
        })
        .catch(error => {
          showNotification('Erro ao carregar dados: ' + error.message, 'error');
          showLoading(false);
        });
    }

    // Atualizar o dashboard com os dados carregados
    function updateDashboard() {
      if (!dashboardData) return;

      // Verificar se há erro nos dados
      if (dashboardData.error) {
        showNotification(dashboardData.error, 'error');
        return;
      }

      // Atualizar cards de resumo
      updateSummaryCards();

      // Atualizar funcionário em destaque
      updateHighlightedEmployee();

      // Atualizar tabelas (se as tabs correspondentes estiverem ativas ou sempre atualizar)
      updateRecentEvaluationsTable();
      if (currentTab === 'ranking' || !document.getElementById('ranking-tbody').hasChildNodes()) updateRankingTable();
      if (currentTab === 'employees' || !document.getElementById('employees-tbody').hasChildNodes()) updateEmployeesTable();
      if (currentTab === 'reports' || !document.getElementById('monthly-reports-tbody').hasChildNodes()) updateReportsTable();


      // Renderizar gráficos
      renderCharts();
    }

    // Atualizar cards de resumo
    function updateSummaryCards() {
      const summary = dashboardData.summary || {}; // Garantir que summary exista

      document.getElementById('total-employees').textContent = summary.totalFuncionarios || 0;
      document.getElementById('total-evaluations').textContent = summary.totalAvaliacoes || 0;
      document.getElementById('average-score').textContent = formatPercent(summary.mediaGeral);

      // Encontrar o funcionário destaque (melhor no ranking)
      let topEmployee = '-';
      let topScore = 0;

      if (dashboardData.ranking && dashboardData.ranking.length > 0) {
        topEmployee = dashboardData.ranking[0].funcionario;
        topScore = dashboardData.ranking[0].media;
        document.getElementById('top-employee').textContent = topEmployee;
        document.getElementById('top-employee-score').textContent = `Pontuação: ${formatPercent(topScore)}`;
      } else {
        document.getElementById('top-employee').textContent = '-';
        document.getElementById('top-employee-score').textContent = 'Pontuação: 0%';
      }

      // Calcular tendência
      let trend = 0;
      if (dashboardData.relatorios && dashboardData.relatorios.length >= 2) {
        // Ordenar relatórios por data para garantir a comparação correta
        const sortedReports = [...dashboardData.relatorios].sort((a, b) => {
            const [monthA, yearA] = a.mesAno.split('/');
            const [monthB, yearB] = b.mesAno.split('/');
            return new Date(yearB, monthB - 1) - new Date(yearA, monthA - 1); // Mais recentes primeiro
        });
        const current = sortedReports[0].mediaGeral;
        const previous = sortedReports[1].mediaGeral;
        if (typeof current === 'number' && typeof previous === 'number') { // Check if numbers
           trend = current - previous;
        }
      }

      const trendElement = document.getElementById('score-trend');
      trendElement.textContent = trend >= 0 ? `+${trend.toFixed(1)}%` : `${trend.toFixed(1)}%`;
      trendElement.className = 'card-trend ' + (trend >= 0 ? 'trend-up' : 'trend-down');
    }

    // Atualizar funcionário em destaque
    function updateHighlightedEmployee() {
      const highlightContainer = document.getElementById('employee-highlight');
      if (!highlightContainer) return; // Safety check

      if (!dashboardData.ranking || dashboardData.ranking.length === 0) {
        document.getElementById('highlight-name').textContent = 'Nenhum funcionário avaliado';
        document.getElementById('highlight-position').textContent = '-';
        document.getElementById('highlight-score').textContent = '0%';
        document.getElementById('highlight-rank').textContent = '-';
        document.getElementById('highlight-evaluations').textContent = '0';
        document.getElementById('employee-avatar').textContent = 'NA';
        return;
      }

      const topEmployee = dashboardData.ranking[0];

      // Encontrar cargo do funcionário
      let position = '-';
      if (dashboardData.funcionarios) {
        const employee = dashboardData.funcionarios.find(f => f.nome === topEmployee.funcionario);
        if (employee) {
          position = employee.cargo;
        }
      }

      document.getElementById('highlight-name').textContent = topEmployee.funcionario;
      document.getElementById('highlight-position').textContent = position;
      document.getElementById('highlight-score').textContent = formatPercent(topEmployee.media);
      document.getElementById('highlight-rank').textContent = topEmployee.posicao;
      document.getElementById('highlight-evaluations').textContent = topEmployee.avaliacoes;

      // Gerar iniciais para o avatar
      const initials = getInitials(topEmployee.funcionario);
      document.getElementById('employee-avatar').textContent = initials;
    }

    // Atualizar tabela de avaliações recentes
    function updateRecentEvaluationsTable() {
      const tbody = document.getElementById('recent-evaluations-tbody');
      tbody.innerHTML = '';

      if (!dashboardData.avaliacoes || dashboardData.avaliacoes.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = '<td colspan="5" class="text-center">Nenhuma avaliação encontrada</td>';
        tbody.appendChild(row);
        return;
      }

      // Ordenar por data (mais recente primeiro)
      const sortedEvaluations = [...dashboardData.avaliacoes].sort((a, b) => {
          // Tentar converter para datas, tratando possíveis erros
          const dateA = new Date(a.dataAvaliacao);
          const dateB = new Date(b.dataAvaliacao);
          if (isNaN(dateA) || isNaN(dateB)) return 0; // Não ordenar se as datas forem inválidas
          return dateB - dateA;
      });


      // Limitar a 10 avaliações mais recentes
      const recentEvaluations = sortedEvaluations.slice(0, 10);

      recentEvaluations.forEach(evaluation => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${evaluation.funcionario || '-'}</td>
          <td>${formatDate(evaluation.dataAvaliacao)}</td>
          <td>${formatDate(evaluation.periodoInicio)} a ${formatDate(evaluation.periodoFim)}</td>
          <td><span class="score-badge ${getScoreClass(evaluation.percentual)}">${formatPercent(evaluation.percentual)}</span></td>
          <td>${evaluation.avaliador || '-'}</td>
        `;
        tbody.appendChild(row);
      });
    }

    // Atualizar tabela de ranking
    function updateRankingTable() {
      const tbody = document.getElementById('ranking-tbody');
      tbody.innerHTML = '';

      if (!dashboardData.ranking || dashboardData.ranking.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = '<td colspan="6" class="text-center">Nenhum funcionário no ranking</td>';
        tbody.appendChild(row);
        return;
      }

      // Filtrar e buscar
      const filteredRanking = dashboardData.ranking.filter(employee => {
        if (!employee) return false; // Skip null/undefined entries

        // Aplicar filtro de pontuação
        const media = employee.media;
        if (currentFilter === 'high' && (media === undefined || media < 80)) return false;
        if (currentFilter === 'medium' && (media === undefined || media < 60 || media > 80)) return false;
        if (currentFilter === 'low' && (media === undefined || media >= 60)) return false;

        // Aplicar busca
        if (searchTerm && (!employee.funcionario || !employee.funcionario.toLowerCase().includes(searchTerm.toLowerCase()))) {
          return false;
        }

        return true;
      });

      if (filteredRanking.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = '<td colspan="6" class="text-center">Nenhum funcionário encontrado com os critérios selecionados</td>';
        tbody.appendChild(row);
        return;
      }

      filteredRanking.forEach(employee => {
        const row = document.createElement('tr');
        const posicao = employee.posicao;
        row.className = `ranking-row-${posicao <= 3 ? posicao : ''}`;

        // Formatar tendência
        const tendencia = employee.tendencia || 0; // Default to 0 if undefined
        const trendClass = tendencia > 0 ? 'trend-up' : tendencia < 0 ? 'trend-down' : '';
        const trendText = tendencia > 0 ? `+${tendencia.toFixed(1)}%` :
                          tendencia < 0 ? `${tendencia.toFixed(1)}%` : '-';

        row.innerHTML = `
          <td><span class="ranking-number">${posicao || '-'}</span></td>
          <td>${employee.funcionario || '-'}</td>
          <td><span class="score-badge ${getScoreClass(employee.media)}">${formatPercent(employee.media)}</span></td>
          <td>${employee.avaliacoes || 0}</td>
          <td><span class="card-trend ${trendClass}">${trendText}</span></td>
          <td>
            <button class="btn-icon view-employee" data-id="${employee.funcionario || ''}" title="Ver detalhes">👁️</button>
            <button class="btn-icon new-evaluation-for" data-id="${employee.funcionario || ''}" title="Nova avaliação">📋</button>
          </td>
        `;
        tbody.appendChild(row);
      });

      // Adicionar event listeners para os botões de ação
      document.querySelectorAll('.view-employee').forEach(btn => {
        btn.addEventListener('click', function() {
          const employeeName = this.getAttribute('data-id');
          if (employeeName) viewEmployeeDetails(employeeName);
        });
      });

      document.querySelectorAll('.new-evaluation-for').forEach(btn => {
        btn.addEventListener('click', function() {
          const employeeName = this.getAttribute('data-id');
          if (employeeName) openEvaluationForm(employeeName);
        });
      });
    }

    // Atualizar tabela de funcionários
    function updateEmployeesTable() {
      const tbody = document.getElementById('employees-tbody');
      tbody.innerHTML = '';

      if (!dashboardData.funcionarios || dashboardData.funcionarios.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = '<td colspan="6" class="text-center">Nenhum funcionário cadastrado</td>';
        tbody.appendChild(row);
        return;
      }

      // Filtrar por busca
      const searchValue = document.getElementById('employee-search').value.toLowerCase();
      const filteredEmployees = dashboardData.funcionarios.filter(employee => {
        if (!employee) return false; // Skip null/undefined

        if (!searchValue) return true;

        const nome = (employee.nome || '').toLowerCase();
        const cargo = (employee.cargo || '').toLowerCase();
        const setor = (employee.setor || '').toLowerCase();

        return (
          nome.includes(searchValue) ||
          cargo.includes(searchValue) ||
          setor.includes(searchValue)
        );
      });

      if (filteredEmployees.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = '<td colspan="6" class="text-center">Nenhum funcionário encontrado com o termo de busca</td>';
        tbody.appendChild(row);
        return;
      }

      filteredEmployees.forEach(employee => {
        const row = document.createElement('tr');
        const status = employee.status || 'Indefinido'; // Default status
        const statusClass = status === 'Ativo' ? 'badge-success' : (status === 'Inativo' ? 'badge-danger' : 'badge-info');

        row.innerHTML = `
          <td>${employee.nome || '-'}</td>
          <td>${employee.cargo || '-'}</td>
          <td>${employee.setor || '-'}</td>
          <td>${formatDate(employee.dataAdmissao)}</td>
          <td><span class="badge ${statusClass}">${status}</span></td>
          <td>
            <button class="btn-icon view-employee" data-id="${employee.nome || ''}" title="Ver detalhes">👁️</button>
            <button class="btn-icon new-evaluation-for" data-id="${employee.nome || ''}" title="Nova avaliação">📋</button>
          </td>
        `;
        tbody.appendChild(row);
      });

      // Adicionar event listeners para os botões de ação (reaplicar)
      document.querySelectorAll('.view-employee').forEach(btn => {
        btn.addEventListener('click', function() {
          const employeeName = this.getAttribute('data-id');
           if (employeeName) viewEmployeeDetails(employeeName);
        });
      });

      document.querySelectorAll('.new-evaluation-for').forEach(btn => {
        btn.addEventListener('click', function() {
          const employeeName = this.getAttribute('data-id');
           if (employeeName) openEvaluationForm(employeeName);
        });
      });
    }

    // Atualizar tabela de relatórios
    function updateReportsTable() {
      const tbody = document.getElementById('monthly-reports-tbody');
      tbody.innerHTML = '';

      if (!dashboardData.relatorios || dashboardData.relatorios.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = '<td colspan="5" class="text-center">Nenhum relatório encontrado</td>';
        tbody.appendChild(row);
        return;
      }

       // Ordenar relatórios por data (mais recente primeiro) para exibição
      const sortedReports = [...dashboardData.relatorios].sort((a, b) => {
          if (!a || !b || !a.mesAno || !b.mesAno) return 0; // Safety check
          const [monthA, yearA] = a.mesAno.split('/');
          const [monthB, yearB] = b.mesAno.split('/');
          // Handle potential errors in parsing date parts
          const dateA = new Date(parseInt(yearA), parseInt(monthA) - 1);
          const dateB = new Date(parseInt(yearB), parseInt(monthB) - 1);
          if (isNaN(dateA) || isNaN(dateB)) return 0;
          return dateB - dateA;
      });


      sortedReports.forEach(report => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${report.mesAno || '-'}</td>
          <td>${report.totalAvaliacoes || 0}</td>
          <td>${formatPercent(report.mediaGeral)}</td>
          <td>${report.melhorFuncionario || '-'}</td>
          <td>
            <button class="btn-icon view-report" data-month="${report.mesAno || ''}" title="Ver detalhes">👁️</button>
            <button class="btn-icon export-report" data-month="${report.mesAno || ''}" title="Exportar">📥</button>
          </td>
        `;
        tbody.appendChild(row);
      });

      // Adicionar event listeners para os botões de ação (reaplicar)
      document.querySelectorAll('.view-report').forEach(btn => {
        btn.addEventListener('click', function() {
          const monthYear = this.getAttribute('data-month');
          if (monthYear) viewMonthlyReport(monthYear);
        });
      });

      document.querySelectorAll('.export-report').forEach(btn => {
        btn.addEventListener('click', function() {
          const monthYear = this.getAttribute('data-month');
          if (monthYear) exportMonthlyReport(monthYear);
        });
      });
    }

    // Renderizar todos os gráficos
    function renderCharts() {
      renderTrendChart();
      renderDistributionChart();
      renderTopEmployeesChart();
      renderSectorStatsChart();
      renderComparativeChart();
    }

    // Renderizar gráfico de tendência
    function renderTrendChart() {
      const canvas = document.getElementById('trend-chart');
      if (!canvas) return;
      const ctx = canvas.getContext('2d');

      // Destruir gráfico existente se houver
      if (charts.trendChart) {
        charts.trendChart.destroy();
      }

      // Preparar dados para o gráfico
      const labels = [];
      const scoreData = [];
      const evaluationsData = [];

      if (dashboardData && dashboardData.relatorios && dashboardData.relatorios.length > 0) {
        // Ordenar relatórios cronologicamente
        const sortedReports = [...dashboardData.relatorios].sort((a, b) => {
          if (!a || !b || !a.mesAno || !b.mesAno) return 0;
          const [monthA, yearA] = a.mesAno.split('/');
          const [monthB, yearB] = b.mesAno.split('/');
          const dateA = new Date(parseInt(yearA), parseInt(monthA) - 1);
          const dateB = new Date(parseInt(yearB), parseInt(monthB) - 1);
          if (isNaN(dateA) || isNaN(dateB)) return 0;
          return dateA - dateB; // Antigos primeiro
        });

        sortedReports.forEach(report => {
          labels.push(report.mesAno || '-');
          scoreData.push(report.mediaGeral !== undefined ? report.mediaGeral : null);
          evaluationsData.push(report.totalAvaliacoes || 0);
        });
      }

      // Criar gráfico
      charts.trendChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Pontuação Média',
              data: scoreData,
              backgroundColor: 'rgba(0, 86, 179, 0.1)',
              borderColor: '#0056b3',
              borderWidth: 2,
              tension: 0.3,
              yAxisID: 'y'
            },
            {
              label: 'Avaliações',
              data: evaluationsData,
              backgroundColor: 'rgba(40, 167, 69, 0.1)',
              borderColor: '#28a745',
              borderWidth: 2,
              tension: 0.3,
              yAxisID: 'y1',
              type: 'bar'
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Pontuação (%)'
              },
              suggestedMax: 100
            },
            y1: {
              beginAtZero: true,
              position: 'right',
              title: {
                display: true,
                text: 'Quantidade'
              },
              grid: {
                drawOnChartArea: false
              }
            },
            x: {
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              }
            }
          },
          plugins: {
            legend: {
              position: 'top'
            },
            tooltip: {
              mode: 'index',
              intersect: false
            }
          }
        }
      });
    }

    // Renderizar gráfico de distribuição
    function renderDistributionChart() {
      const canvas = document.getElementById('distribution-chart');
       if (!canvas) return;
      const ctx = canvas.getContext('2d');

      // Destruir gráfico existente se houver
      if (charts.distributionChart) {
        charts.distributionChart.destroy();
      }

      // Preparar dados para o gráfico
      let highCount = 0;
      let mediumCount = 0;
      let lowCount = 0;

      if (dashboardData && dashboardData.ranking && dashboardData.ranking.length > 0) {
        dashboardData.ranking.forEach(employee => {
          if (employee && employee.media !== undefined) {
            if (employee.media >= 80) {
              highCount++;
            } else if (employee.media >= 60) {
              mediumCount++;
            } else {
              lowCount++;
            }
          }
        });
      }

      // Criar gráfico
      charts.distributionChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Alta Pontuação (>80%)', 'Média Pontuação (60-80%)', 'Baixa Pontuação (<60%)'],
          datasets: [{
            data: [highCount, mediumCount, lowCount],
            backgroundColor: [
              '#28a745',
              '#ffc107',
              '#dc3545'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom'
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const value = context.raw || 0;
                  const total = highCount + mediumCount + lowCount;
                  const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                  return `${value} funcionários (${percentage}%)`;
                }
              }
            }
          }
        }
      });
    }

    // Renderizar gráfico dos melhores funcionários
    function renderTopEmployeesChart() {
       const canvas = document.getElementById('top-employees-chart');
       if (!canvas) return;
      const ctx = canvas.getContext('2d');

      // Destruir gráfico existente se houver
      if (charts.topEmployeesChart) {
        charts.topEmployeesChart.destroy();
      }

      // Preparar dados para o gráfico
      const labels = [];
      const datasets = [];
      const colors = ['#0056b3', '#28a745', '#fd7e14', '#6f42c1', '#20c997'];

      if (dashboardData && dashboardData.ranking && dashboardData.ranking.length > 0 &&
          dashboardData.historico && dashboardData.historico.length > 0) {

        // Pegar os 5 melhores funcionários
        const topEmployees = dashboardData.ranking.slice(0, 5).map(e => e ? e.funcionario : null).filter(name => name); // Get names, filter nulls

        // Encontrar todos os meses/anos no histórico
        const monthsSet = new Set(dashboardData.historico.map(h => h ? h.mesAno : null).filter(m => m)); // Get months, filter nulls
        const months = [...monthsSet];
        months.sort((a, b) => {
            const [monthA, yearA] = a.split('/');
            const [monthB, yearB] = b.split('/');
            const dateA = new Date(parseInt(yearA), parseInt(monthA) - 1);
            const dateB = new Date(parseInt(yearB), parseInt(monthB) - 1);
            if (isNaN(dateA) || isNaN(dateB)) return 0;
            return dateA - dateB; // Antigos primeiro
        });


        // Criar labels com os meses
        labels.push(...months);

        // Criar datasets para cada funcionário
        topEmployees.forEach((employee, index) => {
          const employeeData = months.map(month => {
            const entry = dashboardData.historico.find(h => h && h.funcionario === employee && h.mesAno === month);
            return entry && entry.pontuacao !== undefined ? entry.pontuacao : null;
          });

          datasets.push({
            label: employee,
            data: employeeData,
            borderColor: colors[index % colors.length],
            backgroundColor: `${colors[index % colors.length]}33`, // Slightly more opaque fill
            tension: 0.3,
            fill: false,
            spanGaps: true // Connect points across nulls
          });
        });
      }

      // Criar gráfico
      charts.topEmployeesChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: datasets
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Pontuação (%)'
              },
              suggestedMax: 100
            },
            x: {
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              }
            }
          },
          plugins: {
            legend: {
              position: 'top'
            },
            tooltip: {
              mode: 'index',
              intersect: false
            }
          }
        }
      });
    }

    // Renderizar gráfico de estatísticas por setor
    function renderSectorStatsChart() {
      const canvas = document.getElementById('sector-stats-chart');
       if (!canvas) return;
      const ctx = canvas.getContext('2d');

      // Destruir gráfico existente se houver
      if (charts.sectorStatsChart) {
        charts.sectorStatsChart.destroy();
      }

      // Preparar dados para o gráfico
      const sectors = {};

      if (dashboardData && dashboardData.funcionarios && dashboardData.funcionarios.length > 0 &&
          dashboardData.avaliacoes && dashboardData.avaliacoes.length > 0) {

        // Agrupar funcionários por setor
        dashboardData.funcionarios.forEach(employee => {
          if (employee && employee.setor) { // Ensure employee and sector exist
            if (!sectors[employee.setor]) {
              sectors[employee.setor] = {
                count: 0,
                evaluations: 0,
                totalScore: 0
              };
            }

            sectors[employee.setor].count++;

            // Contar avaliações e pontuação total deste funcionário
            const employeeEvaluations = dashboardData.avaliacoes.filter(ev => ev && ev.funcionario === employee.nome);
            sectors[employee.setor].evaluations += employeeEvaluations.length;

            employeeEvaluations.forEach(ev => {
                if (ev && typeof ev.percentual === 'number') {
                   sectors[employee.setor].totalScore += ev.percentual;
                }
            });
          }
        });
      }

      // Calcular médias e preparar dados
      const labels = Object.keys(sectors);
      const countsData = [];
      const evaluationsData = [];
      const averageScoresData = [];

      labels.forEach(sector => {
        countsData.push(sectors[sector].count);
        evaluationsData.push(sectors[sector].evaluations);

        const averageScore = sectors[sector].evaluations > 0 ?
                             (sectors[sector].totalScore / sectors[sector].evaluations) : 0;
        averageScoresData.push(averageScore);
      });

      // Criar gráfico
      charts.sectorStatsChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Funcionários',
              data: countsData,
              backgroundColor: '#0056b3',
              borderWidth: 0,
              barPercentage: 0.5,
              categoryPercentage: 0.8
            },
            {
              label: 'Avaliações',
              data: evaluationsData,
              backgroundColor: '#28a745',
              borderWidth: 0,
              barPercentage: 0.5,
              categoryPercentage: 0.8
            },
            {
              label: 'Pontuação Média',
              data: averageScoresData,
              type: 'line',
              backgroundColor: 'rgba(253, 126, 20, 0.2)',
              borderColor: '#fd7e14',
              borderWidth: 2,
              tension: 0.3,
              yAxisID: 'y1'
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Quantidade'
              }
            },
            y1: {
              beginAtZero: true,
              position: 'right',
              title: {
                display: true,
                text: 'Pontuação (%)'
              },
              grid: {
                drawOnChartArea: false
              },
              suggestedMax: 100
            },
            x: {
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              }
            }
          },
          plugins: {
            legend: {
              position: 'top'
            },
            tooltip: {
              mode: 'index',
              intersect: false
            }
          }
        }
      });
    }

    // Renderizar gráfico comparativo
    function renderComparativeChart() {
      const canvas = document.getElementById('comparative-chart');
       if (!canvas) return;
      const ctx = canvas.getContext('2d');

      // Destruir gráfico existente se houver
      if (charts.comparativeChart) {
        charts.comparativeChart.destroy();
      }

      // Preparar dados para o gráfico
      const labels = [];
      const averageScores = [];
      const topScores = [];
      const bottomScores = [];

      if (dashboardData && dashboardData.relatorios && dashboardData.relatorios.length > 0 &&
          dashboardData.historico && dashboardData.historico.length > 0) {

        // Ordenar relatórios cronologicamente
        const sortedReports = [...dashboardData.relatorios].sort((a, b) => {
           if (!a || !b || !a.mesAno || !b.mesAno) return 0;
           const [monthA, yearA] = a.mesAno.split('/');
           const [monthB, yearB] = b.mesAno.split('/');
           const dateA = new Date(parseInt(yearA), parseInt(monthA) - 1);
           const dateB = new Date(parseInt(yearB), parseInt(monthB) - 1);
           if (isNaN(dateA) || isNaN(dateB)) return 0;
           return dateA - dateB; // Antigos primeiro
        });

        // Para cada relatório, pegar a média geral e as pontuações top/bottom
        sortedReports.forEach(report => {
          if (!report || !report.mesAno) return; // Skip if report or mesAno is invalid

          labels.push(report.mesAno);
          averageScores.push(report.mediaGeral !== undefined ? report.mediaGeral : null);

          // Encontrar pontuações máxima e mínima para esse mês
          const monthEntries = dashboardData.historico.filter(h => h && h.mesAno === report.mesAno && h.pontuacao !== undefined);
          if (monthEntries.length > 0) {
            const sortedEntries = [...monthEntries].sort((a, b) => b.pontuacao - a.pontuacao);
            topScores.push(sortedEntries[0].pontuacao);
            bottomScores.push(sortedEntries[sortedEntries.length - 1].pontuacao);
          } else {
            topScores.push(null);
            bottomScores.push(null);
          }
        });
      }

      // Criar gráfico
      charts.comparativeChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Melhor Pontuação',
              data: topScores,
              borderColor: '#28a745',
              backgroundColor: 'rgba(40, 167, 69, 0.1)',
              borderWidth: 2,
              tension: 0.3,
              fill: false,
              spanGaps: true
            },
            {
              label: 'Média Geral',
              data: averageScores,
              borderColor: '#0056b3',
              backgroundColor: 'rgba(0, 86, 179, 0.1)',
              borderWidth: 2,
              tension: 0.3,
              fill: false,
              spanGaps: true
            },
            {
              label: 'Pior Pontuação',
              data: bottomScores,
              borderColor: '#dc3545',
              backgroundColor: 'rgba(220, 53, 69, 0.1)',
              borderWidth: 2,
              tension: 0.3,
              fill: false,
              spanGaps: true
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Pontuação (%)'
              },
              suggestedMax: 100
            },
            x: {
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              }
            }
          },
          plugins: {
            legend: {
              position: 'top'
            },
            tooltip: {
              mode: 'index',
              intersect: false
            }
          }
        }
      });
    }

    // Abrir formulário de avaliação
    function openEvaluationForm(employeeName = '') {
      resetEvaluationForm();

      document.getElementById('evaluation-form-overlay').style.display = 'block';

      // Se fornecido um nome de funcionário, preencher o campo
      if (employeeName) {
        document.getElementById('employee-name').value = employeeName;
      }

      goToFormStep(1);

      // Gerar campos de critérios de avaliação
      generateEvaluationCriteria();
    }

    // Fechar formulário de avaliação
    function closeEvaluationForm() {
      document.getElementById('evaluation-form-overlay').style.display = 'none';
    }

    // Resetar formulário de avaliação
    function resetEvaluationForm() {
      const form = document.getElementById('evaluation-form');
      if (form) form.reset(); // Check if form exists

      // Limpar campos dinâmicos
      const criteriaContainer = document.getElementById('evaluation-criteria');
      if (criteriaContainer) criteriaContainer.innerHTML = '';
      const summaryContainer = document.getElementById('evaluation-summary');
      if (summaryContainer) summaryContainer.innerHTML = '';
    }

    // Abrir formulário de funcionário
    function openEmployeeForm() {
      resetEmployeeForm();
      document.getElementById('employee-form-overlay').style.display = 'block';
    }

    // Fechar formulário de funcionário
    function closeEmployeeForm() {
      document.getElementById('employee-form-overlay').style.display = 'none';
    }

    // Resetar formulário de funcionário
    function resetEmployeeForm() {
       const form = document.getElementById('employee-form');
       if (form) form.reset();
    }

    // Navegar para uma etapa do formulário
    function goToFormStep(step) {
      // Ocultar todas as etapas
      document.querySelectorAll('.form-step-content').forEach(content => {
        content.style.display = 'none';
      });

      // Atualizar classes das etapas
      document.querySelectorAll('.form-step').forEach(stepEl => {
        const stepNum = parseInt(stepEl.getAttribute('data-step'));

        stepEl.classList.remove('active', 'completed');

        if (stepNum === step) {
          stepEl.classList.add('active');
        } else if (stepNum < step) {
          stepEl.classList.add('completed');
        }
      });

      // Mostrar a etapa atual
      const currentStepContent = document.getElementById(`step-${step}-content`);
      if(currentStepContent) {
        currentStepContent.style.display = 'block';
      }
    }

    // Gerar campos de critérios de avaliação
    function generateEvaluationCriteria() {
      const container = document.getElementById('evaluation-criteria');
      container.innerHTML = '';

      if (!criteriosAvaliacao || criteriosAvaliacao.length === 0) {
        container.innerHTML = '<div class="text-center" style="padding: 20px;">Critérios de avaliação não carregados ou vazios.</div>';
        // Tentar recarregar se vazio
        if(!criteriosAvaliacao || criteriosAvaliacao.length === 0) {
            loadCriteriosAvaliacao();
        }
        return;
      }

      criteriosAvaliacao.forEach((criterio, index) => {
          if (!criterio || !criterio.id || !criterio.titulo) { // Skip invalid criteria
              console.warn('Critério inválido encontrado:', criterio);
              return;
          }

        const criterioItem = document.createElement('div');
        criterioItem.className = 'form-item';
        criterioItem.setAttribute('data-id', criterio.id);

        const criterioHeader = document.createElement('div');
        criterioHeader.className = 'form-item-header';

        const criterioNumber = document.createElement('div');
        criterioNumber.className = 'form-item-number';
        criterioNumber.textContent = index + 1;

        const criterioTitle = document.createElement('div');
        criterioTitle.className = 'form-item-title';
        criterioTitle.textContent = criterio.titulo;

        criterioHeader.appendChild(criterioNumber);
        criterioHeader.appendChild(criterioTitle);
        criterioItem.appendChild(criterioHeader);

        // Opções de resposta
        const options = ['SIM', 'NÃO', 'NA'];

        options.forEach((option, optIndex) => {
          const formCheck = document.createElement('div');
          formCheck.className = 'form-check';

          const input = document.createElement('input');
          input.type = 'radio';
          input.id = `${criterio.id}-${optIndex}`;
          input.name = criterio.id;
          input.value = option;
          input.required = true; // Make radios required for form validation if needed

          const label = document.createElement('label');
          label.setAttribute('for', `${criterio.id}-${optIndex}`);
          label.textContent = option;

          formCheck.appendChild(input);
          formCheck.appendChild(label);
          criterioItem.appendChild(formCheck);
        });

        container.appendChild(criterioItem);
      });
    }

    // Atualizar resumo da avaliação
    function updateEvaluationSummary() {
      const summary = document.getElementById('evaluation-summary');
      summary.innerHTML = '';

      const employeeName = document.getElementById('employee-name').value || '[Não informado]';
      const evaluatorName = document.getElementById('evaluator-name').value || '[Não informado]';
      const startDate = document.getElementById('start-date').value;
      const endDate = document.getElementById('end-date').value;

      // Calcular pontuação
      let totalSim = 0;
      let totalNao = 0;
      let totalNA = 0;

      criteriosAvaliacao.forEach(criterio => {
          if (!criterio || !criterio.id) return; // Skip invalid criteria

        const selectedOption = document.querySelector(`input[name="${criterio.id}"]:checked`);
        if (selectedOption) {
          const value = selectedOption.value;

          // Tratamento específico para itens negativos (abriu_direito_recusa e possui_falta)
          // Adicione mais IDs aqui se necessário
          const negativeCriteriaIds = ['abriu_direito_recusa', 'possui_falta'];
          const isNegative = negativeCriteriaIds.includes(criterio.id);

          if (value === 'SIM') {
              if (isNegative) totalNao++; else totalSim++;
          } else if (value === 'NÃO') {
              if (isNegative) totalSim++; else totalNao++;
          } else if (value === 'NA') {
              totalNA++;
          }

        }
      });

      const totalConsidered = totalSim + totalNao; // Only consider SIM/NÃO for percentage
      const percentual = totalConsidered > 0 ? (totalSim / totalConsidered) * 100 : 0;

      // Criar o resumo
      const infoDiv = document.createElement('div');
      infoDiv.innerHTML = `
        <div class="form-row">
          <div class="form-col">
            <strong>Funcionário:</strong> ${employeeName}
          </div>
          <div class="form-col">
            <strong>Avaliador:</strong> ${evaluatorName}
          </div>
        </div>
        <div class="form-row">
          <div class="form-col">
            <strong>Período:</strong> ${formatDate(startDate)} a ${formatDate(endDate)}
          </div>
          <div class="form-col">
            <strong>Data da avaliação:</strong> ${formatDate(new Date(), true)}
          </div>
        </div>
        <div class="form-row" style="margin-top: 15px;">
          <div class="form-col">
            <strong>Pontuação:</strong> <span class="score-badge ${getScoreClass(percentual)}">${formatPercent(percentual)}</span>
          </div>
          <div class="form-col">
            <strong>Itens (SIM/NÃO/NA):</strong> ${totalSim} / ${totalNao} / ${totalNA}
          </div>
        </div>
      `;

      summary.appendChild(infoDiv);
    }

    // Submeter formulário de avaliação
    function submitEvaluation() {
      // Coletar dados do formulário
      const employeeName = document.getElementById('employee-name').value;
      const evaluatorName = document.getElementById('evaluator-name').value;
      const startDate = document.getElementById('start-date').value;
      const endDate = document.getElementById('end-date').value;
      const sector = document.getElementById('sector').value;
      const observations = document.getElementById('observations').value;

      // Coletar respostas dos critérios
      const respostas = {};
      let allAnswered = true; // Re-check just before submitting
      criteriosAvaliacao.forEach(criterio => {
         if (!criterio || !criterio.id) return;
        const selectedOption = document.querySelector(`input[name="${criterio.id}"]:checked`);
        if (selectedOption) {
          respostas[criterio.id] = selectedOption.value;
        } else {
            allAnswered = false;
        }
      });

      if (!allAnswered) {
          showNotification('Erro: Nem todos os critérios foram respondidos. Verifique a etapa 2.', 'error');
          goToFormStep(2); // Go back to criteria step
          return;
      }

      // Preparar dados para envio
      const data = {
        funcionario: employeeName,
        avaliador: evaluatorName,
        periodoInicio: startDate,
        periodoFim: endDate,
        setor: sector,
        observacoes: observations,
        respostas: respostas
      };

      // Enviar para a API
      showLoading(true, 'Salvando avaliação...');

      callAPI('salvarAvaliacao', data)
        .then(result => {
          showLoading(false);

          if (result && result.success) { // Check if result and success exist
            showNotification('Avaliação registrada com sucesso!', 'success');
            closeEvaluationForm();
            loadDashboardData(); // Reload data to reflect changes
          } else {
            showNotification('Erro ao registrar avaliação: ' + (result ? result.message : 'Resposta inválida da API'), 'error');
          }
        })
        .catch(error => {
          showLoading(false);
          showNotification('Erro ao enviar dados: ' + error.message, 'error');
        });
    }

    // Submeter formulário de funcionário
    function submitEmployee() {
      // Coletar dados do formulário
      const nome = document.getElementById('new-employee-name').value;
      const cargo = document.getElementById('new-employee-position').value;
      const setor = document.getElementById('new-employee-sector').value;
      const dataAdmissao = document.getElementById('admission-date').value;

      // Validação básica
      if (!nome || !cargo || !setor) {
         showNotification('Por favor, preencha Nome, Cargo e Setor.', 'error');
         return;
      }


      // Preparar dados para envio
      const data = {
        nome: nome,
        cargo: cargo,
        setor: setor,
        dataAdmissao: dataAdmissao // Pode ser vazio
      };

      // Enviar para a API
      showLoading(true, 'Salvando funcionário...');

      callAPI('adicionarFuncionario', data)
        .then(result => {
          showLoading(false);

          if (result && result.success) {
            showNotification('Funcionário cadastrado com sucesso!', 'success');
            closeEmployeeForm();
            loadDashboardData(); // Recarregar dados

            // Se estava no processo de avaliação, tentar reabrir
            const evaluationNameInput = document.getElementById('employee-name');
            if (evaluationNameInput && evaluationNameInput.value === nome) {
              openEvaluationForm(nome);
            }
          } else {
            showNotification('Erro ao cadastrar funcionário: ' + (result ? result.message : 'Resposta inválida da API'), 'error');
          }
        })
        .catch(error => {
          showLoading(false);
          showNotification('Erro ao enviar dados: ' + error.message, 'error');
        });
    }

    // Ver detalhes de um funcionário
    function viewEmployeeDetails(employeeName) {
      // Implementar visualização detalhada do funcionário (placeholder)
      // Poderia abrir um modal com informações, histórico de avaliações, etc.
      showNotification(`Exibindo detalhes de ${employeeName}... (Implementação futura)`, 'info');
      console.log("Detalhes do funcionário:", employeeName, dashboardData.funcionarios.find(f => f.nome === employeeName));
    }

    // Ver relatório mensal
    function viewMonthlyReport(monthYear) {
      // Implementar visualização detalhada do relatório mensal (placeholder)
       // Poderia abrir um modal com o ranking daquele mês, médias, etc.
      showNotification(`Exibindo relatório de ${monthYear}... (Implementação futura)`, 'info');
       console.log("Detalhes do relatório:", monthYear, dashboardData.relatorios.find(r => r.mesAno === monthYear));
    }

    // Exportar relatório mensal
    function exportMonthlyReport(monthYear) {
      // Implementar exportação do relatório mensal (placeholder)
      showNotification(`Iniciando exportação do relatório de ${monthYear}... (Implementação futura)`, 'info');
       // Poderia chamar uma função da API para gerar e baixar um CSV/PDF
    }

    // Sistema de notificações
    function showNotification(message, type = 'info') {
      // Remover notificações existentes para evitar acúmulo
      const existingNotifications = document.querySelectorAll('.notification-popup');
      existingNotifications.forEach(notification => {
         if (document.body.contains(notification)) {
            document.body.removeChild(notification);
         }
      });

      // Criar elemento de notificação
      const notification = document.createElement('div');
      notification.className = `notification-popup ${type}`;

      // Ícone baseado no tipo
      let icon = '';
      let title = '';

      switch (type) {
        case 'success':
          icon = '✓';
          title = 'Sucesso';
          break;
        case 'error':
          icon = '✗';
          title = 'Erro';
          break;
        case 'info':
        default:
          icon = 'ℹ';
          title = 'Informação';
          break;
      }

      // Adicionar conteúdo
      notification.innerHTML = `
        <div class="notification-icon">${icon}</div>
        <div class="notification-content">
          <div class="notification-title">${title}</div>
          <div>${message}</div>
        </div>
        <span class="close-btn">&times;</span>
      `;

      // Adicionar à página
      document.body.appendChild(notification);

      // Configurar botão de fechar
      const closeBtn = notification.querySelector('.close-btn');
      closeBtn.addEventListener('click', function() {
        notification.style.animation = 'fadeOut 0.3s forwards';
        setTimeout(() => {
          if (document.body.contains(notification)) {
            document.body.removeChild(notification);
          }
        }, 300);
      });

      // Auto-fechar após 5 segundos
      setTimeout(function() {
        if (document.body.contains(notification)) {
          notification.style.animation = 'fadeOut 0.3s forwards';
          setTimeout(() => {
            if (document.body.contains(notification)) {
              document.body.removeChild(notification);
            }
          }, 300);
        }
      }, 5000);
    }

    // Mostrar/esconder indicador de carregamento
    function showLoading(show, message = 'Carregando dados...') {
      // Remover loader existente
      const existingLoader = document.getElementById('global-loader');
      if (existingLoader) {
        existingLoader.remove(); // Use remove() for cleaner removal
      }

      if (show) {
        // Criar loader
        const loader = document.createElement('div');
        loader.id = 'global-loader';
        loader.style.position = 'fixed';
        loader.style.top = '0';
        loader.style.left = '0';
        loader.style.width = '100%';
        loader.style.height = '100%';
        loader.style.backgroundColor = 'rgba(0,0,0,0.5)';
        loader.style.display = 'flex';
        loader.style.alignItems = 'center';
        loader.style.justifyContent = 'center';
        loader.style.zIndex = '2000';
        loader.style.color = '#333'; // Make text visible on white background

        const content = document.createElement('div');
        content.style.backgroundColor = 'white';
        content.style.padding = '20px 30px';
        content.style.borderRadius = '8px';
        content.style.boxShadow = '0 5px 15px rgba(0,0,0,0.2)';
        content.style.textAlign = 'center';
        content.style.display = 'flex'; // Align spinner and text
        content.style.alignItems = 'center';
        content.style.gap = '15px'; // Space between spinner and text

        // Spinner CSS
        const spinner = document.createElement('div');
        spinner.style.width = '30px';
        spinner.style.height = '30px';
        spinner.style.border = '4px solid #f3f3f3';
        spinner.style.borderTop = '4px solid var(--primary-color)'; // Use theme color
        spinner.style.borderRadius = '50%';
        spinner.style.animation = 'spin 1s linear infinite';

        const messageDiv = document.createElement('div');
        messageDiv.textContent = message;

        content.appendChild(spinner);
        content.appendChild(messageDiv);
        loader.appendChild(content);
        document.body.appendChild(loader);

        // Adicionar estilo para animação se não existir
        if (!document.getElementById('spin-style')) {
             const style = document.createElement('style');
             style.id = 'spin-style';
             style.textContent = `
               @keyframes spin {
                 0% { transform: rotate(0deg); }
                 100% { transform: rotate(360deg); }
               }
             `;
             document.head.appendChild(style);
        }
      }
    }

    // Funções utilitárias

    // Formatar data
    function formatDate(dateString, includeTime = false) {
      if (!dateString) return '-';

      const date = new Date(dateString);

      // Check if the date is valid. Handle cases where dateString might not be parsable.
      if (isNaN(date.getTime())) {
          // Try to handle potential ISO strings without timezone correctly
          // Handle cases like '2023-10-26T10:00:00.000Z' by ensuring it's parsed as UTC
          // Handle cases like '10/26/2023' by hoping the local parser gets it right
           const parts = String(dateString).split(/[-/T:]/);
           let adjustedDate;
           if (parts.length >= 3 && String(dateString).includes('T')) { // Likely ISO-ish
                adjustedDate = new Date(Date.UTC(parts[0], parts[1] - 1, parts[2], parts[3] || 0, parts[4] || 0, parts[5] || 0));
           } else if (parts.length === 3) { // Maybe MM/DD/YYYY or YYYY-MM-DD
                // Attempt a common format parse if initial fails (less reliable)
                adjustedDate = new Date(parts[2].length === 4 ? parts[2] : parts[0], parts[0].length === 4 ? parts[1]-1 : parts[0]-1, parts[0].length === 4 ? parts[2] : parts[1]);
           }

           if (!adjustedDate || isNaN(adjustedDate.getTime())) {
               return '-'; // Return '-' if still invalid
           }
           date = adjustedDate; // Use the adjusted date if valid
      }


      const optionsDate = {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
      };

      const optionsDateTime = {
        ...optionsDate,
        hour: '2-digit',
        minute: '2-digit'
      };

      try {
        return date.toLocaleDateString('pt-BR', includeTime ? optionsDateTime : optionsDate);
      } catch (e) {
        console.error("Error formatting date:", dateString, e);
        return '-'; // Fallback if formatting fails
      }
    }

    // Formatar percentual
    function formatPercent(value) {
      if (value === null || value === undefined || typeof value !== 'number' || isNaN(value)) {
         return '0.0%'; // Ensure it always returns a string ending in %
      }
      return `${value.toFixed(1)}%`;
    }

    // Obter classe CSS baseada na pontuação
    function getScoreClass(score) {
        if (score === null || score === undefined || typeof score !== 'number' || isNaN(score)) {
            return 'score-medium'; // Default or handle as needed
        }
      if (score >= 80) return 'score-high';
      if (score >= 60) return 'score-medium';
      return 'score-low';
    }

    // Obter iniciais de um nome
    function getInitials(name) {
      if (!name || typeof name !== 'string') return 'NA';

      const words = name.trim().split(/\s+/).filter(word => word.length > 0); // Split by any whitespace, remove empty

      if (words.length === 0) return 'NA';
      if (words.length === 1) return words[0].charAt(0).toUpperCase();

      // Get first char of first word and first char of last word
      return (words[0].charAt(0) + words[words.length - 1].charAt(0)).toUpperCase();
    }

  </script>

</body>
</html>
